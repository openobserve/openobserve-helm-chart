{{- if .Values.gateway.enabled -}}
{{- $fullName := include "openobserve.fullname" . -}}
{{- range .Values.gateway.httpRoutes.routes }}
---
apiVersion: gateway.networking.k8s.io/v1
kind: HTTPRoute
metadata:
  name: {{ $fullName }}-{{ .name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    {{- include "openobserve.labels" $ | nindent 4 }}
    {{- with $.Values.gateway.httpRoutes.labels }}
    {{- toYaml . | nindent 4 }}
    {{- end }}
  {{- with $.Values.gateway.httpRoutes.annotations }}
  annotations:
    {{- toYaml . | nindent 4 }}
  {{- end }}
spec:
  parentRefs:
    {{- range .gateways }}
    {{- if kindIs "string" . }}
    # Simple string format - use gateway name with release namespace
    - name: {{ . }}
      namespace: {{ $.Release.Namespace }}
    {{- else }}
    # Object format - full control over gateway reference
    - name: {{ .name }}
      {{- if .namespace }}
      namespace: {{ .namespace }}
      {{- else }}
      namespace: {{ $.Release.Namespace }}
      {{- end }}
      {{- if .sectionName }}
      sectionName: {{ .sectionName }}
      {{- end }}
    {{- end }}
    {{- end }}
  {{- with .hostnames }}
  hostnames:
    {{- range . }}
    - {{ . | quote }}
    {{- end }}
  {{- end }}
  rules:
    # Block /metrics endpoint - returns 403 via EnvoyPatchPolicy (always added)
    - matches:
        - path:
            type: Exact
            value: /metrics
    # Block /api/metrics endpoint - returns 403 via EnvoyPatchPolicy (always added)
    - matches:
        - path:
            type: Exact
            value: /api/metrics
    # User-defined rules
    {{- range $ruleIndex, $rule := .rules }}
    - {{- if $rule.matches }}
      matches:
        {{- range $rule.matches }}
        - {{- if .path }}
          path:
            type: {{ .path.type | default "PathPrefix" }}
            value: {{ .path.value | quote }}
          {{- end }}
          {{- if .headers }}
          headers:
            {{- range .headers }}
            - name: {{ .name }}
              type: {{ .type | default "Exact" }}
              value: {{ .value | quote }}
            {{- end }}
          {{- end }}
          {{- if .queryParams }}
          queryParams:
            {{- range .queryParams }}
            - name: {{ .name }}
              type: {{ .type | default "Exact" }}
              value: {{ .value | quote }}
            {{- end }}
          {{- end }}
          {{- if .method }}
          method: {{ .method }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- if $rule.filters }}
      filters:
        {{- range $rule.filters }}
        - type: {{ .type }}
          {{- if eq .type "RequestRedirect" }}
          requestRedirect:
            {{- toYaml .requestRedirect | nindent 12 }}
          {{- else if eq .type "RequestHeaderModifier" }}
          requestHeaderModifier:
            {{- toYaml .requestHeaderModifier | nindent 12 }}
          {{- else if eq .type "ResponseHeaderModifier" }}
          responseHeaderModifier:
            {{- toYaml .responseHeaderModifier | nindent 12 }}
          {{- else if eq .type "RequestMirror" }}
          requestMirror:
            {{- toYaml .requestMirror | nindent 12 }}
          {{- else if eq .type "URLRewrite" }}
          urlRewrite:
            {{- toYaml .urlRewrite | nindent 12 }}
          {{- else if eq .type "ExtensionRef" }}
          extensionRef:
            {{- toYaml .extensionRef | nindent 12 }}
          {{- end }}
        {{- end }}
      {{- end }}
      {{- if $rule.backendRefs }}
      backendRefs:
        {{- range $rule.backendRefs }}
        - name: {{ .name }}
          port: {{ .port }}
          {{- if .weight }}
          weight: {{ .weight }}
          {{- end }}
          {{- if .filters }}
          filters:
            {{- range .filters }}
            - type: {{ .type }}
              {{- if eq .type "RequestRedirect" }}
              requestRedirect:
                {{- toYaml .requestRedirect | nindent 16 }}
              {{- else if eq .type "RequestHeaderModifier" }}
              requestHeaderModifier:
                {{- toYaml .requestHeaderModifier | nindent 16 }}
              {{- else if eq .type "ResponseHeaderModifier" }}
              responseHeaderModifier:
                {{- toYaml .responseHeaderModifier | nindent 16 }}
              {{- else if eq .type "RequestMirror" }}
              requestMirror:
                {{- toYaml .requestMirror | nindent 16 }}
              {{- else if eq .type "URLRewrite" }}
              urlRewrite:
                {{- toYaml .urlRewrite | nindent 16 }}
              {{- else if eq .type "ExtensionRef" }}
              extensionRef:
                {{- toYaml .extensionRef | nindent 16 }}
              {{- end }}
            {{- end }}
          {{- end }}
        {{- end }}
      {{- end }}
    {{- end }}
{{- end }}
{{- end }}
